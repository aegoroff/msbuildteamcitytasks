<?xml version="1.0" encoding="utf-8"?>
<Project DefaultTargets="Build" ToolsVersion="4.0" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
	<!-- Importing MSBuild Community Tasks -->
	<Import Project="$(MSBuildExtensionsPath)\MSBuildCommunityTasks\MSBuild.Community.Tasks.Targets"/>
	<!-- Importing MSBuild TeamCity Tasks -->
	<Import Project="$(MSBuildExtensionsPath)\MSBuildTeamCityTasks\MSBuild.TeamCity.Tasks.Targets"/>
	<!-- Global properties definitions -->
	<PropertyGroup>

		<!-- Code configuration to build (Release or Debug) -->
		<Configuration>Release</Configuration>
		<!-- NUnit working path  -->
		<NUnitPath>C:\Program Files (x86)\NUnit 2.6\bin</NUnitPath>
		<PartCoverPath>C:\Program Files (x86)\PartCover\PartCover .NET 4.0</PartCoverPath>
		<OpenCoverPath>C:\Program Files (x86)\OpenCover</OpenCoverPath>
		<ReportGeneratorPath>D:\soft\Programming\NET tools\ReportGenerator_1.2.6.0</ReportGeneratorPath>
		
		<!-- Binaries zip  -->
		<BinariesFile>Binaries.zip</BinariesFile>
		
		<!-- Reports zip  -->
		<ReportsFile>Reports.zip</ReportsFile>
		
		<!-- Enables updating version mechanism -->
		<IsUpdateVersion>false</IsUpdateVersion>
		
		<!-- Managed unit tests report  -->
		<ManagedTestsReport>ManagedTests.xml</ManagedTestsReport>
		
		<!-- Version components  -->
		<Major>2</Major>
		<Minor>1</Minor>
		<Build>0</Build>
		<Revision>0</Revision>
		<!-- Development cycle stage (alpha, beta, etc.) -->
		<Stage>alpha</Stage>
		<!-- Can be Featured or empty Featured means to place it on main project page -->
		<IsFeatured>Featured</IsFeatured>
		<GoogleLogin>1</GoogleLogin>
		<GooglePassword>1</GooglePassword>
		<IsUpload>false</IsUpload>
	</PropertyGroup>
	<!-- Coverage report output file-->
	<ItemGroup>
		<CoverageFile Include="$(MSBuildProjectDirectory)\$(CoverageOutFile)" />
	</ItemGroup>
	<!-- AssemblyInfo.cs file definitions where to set version -->
	<ItemGroup>
		<AssemblyInfoFile Include="$(MSBuildProjectDirectory)\**\AssemblyInfo.cs" />
	</ItemGroup>
	<!-- Updating version and product code task -->
	<Target Name="VersionUpdater" Condition=" '$(IsUpdateVersion)'=='true' ">
		<!-- Updating AssemblyInfo.cs files -->
		<FileUpdate
			Files="@(AssemblyInfoFile)"
			Regex='\[assembly(\s*):(\s*)(AssemblyVersion|AssemblyFileVersion|AssemblyInformationalVersionAttribute)\((\s*)"(\d+)\.(\d+)\.(\d+)\.(\d+)"(\s*)\)\]'
			ReplacementText='[assembly : $3("$(Major).$(Minor).$(Build).$(Revision)")]' />
		<!-- Updating WiX files -->
		<FileUpdate
			Files="$(MSBuildProjectDirectory)\Setup\Product.wxs"
			Regex='define Version = "(\d+)\.(\d+)\.(\d+).(\d+)"'
			ReplacementText='define Version = "$(Major).$(Minor).$(Build).$(Revision)"' />

	</Target>
	<ItemGroup>
		<SetupFile Include="$(MSBuildProjectDirectory)\Setup\bin\$(Configuration)\MSBuild.TeamCity.Tasks.Setup.msi" />
	</ItemGroup>
	<ItemGroup>
		<SetupDestinationFile Include="$(MSBuildProjectDirectory)\MSBuild.TeamCity.Tasks.$(Major).$(Minor).$(Build).$(Revision).msi" />
	</ItemGroup>
	<!-- Main build step where solution file are built -->
	<Target Name="Compile" DependsOnTargets="VersionUpdater">
		<!-- Start building solution file -->
		<MSBuild
			StopOnFirstFailure="true"
			Projects="MSBuild.TeamCity.Tasks.sln"
			Properties="Configuration=$(Configuration)" 
		/>
	</Target>
	<!-- Running server's and GUI's unit tests task -->
	<Target Name="UnitTesting" DependsOnTargets="Compile">
		<!-- Managed tests -->
		<Exec
			Command='"$(OpenCoverPath)\opencover.console.exe" "-target:$(NUnitPath)\nunit-console.exe" "-targetargs:/xml:$(MSBuildProjectDirectory)\$(ManagedTestsReport) $(MSBuildProjectDirectory)\Tests\bin\$(Configuration)\Tests.dll /framework:net-4.0 /config=$(Configuration)" -filter:+MSBuild.TeamCity.Tasks]* "-targetdir:$(MSBuildProjectDirectory)\Tests\bin\$(Configuration)" -register:user "-output:$(MSBuildProjectDirectory)\OpenCoverageReport.xml"'
			IgnoreExitCode="true"
		/>
		<Exec
			Command='"$(ReportGeneratorPath)\bin\ReportGenerator.exe" "$(MSBuildProjectDirectory)\OpenCoverageReport.xml" "$(MSBuildProjectDirectory)\OpenCoverage" Html'
			IgnoreExitCode="true"
		/>
		<!-- Import into TeamCity mono tests -->
		<ImportData Type="nunit" Path="$(MSBuildProjectDirectory)\$(ManagedTestsReport)" />
	</Target>
	
	<!-- Zipping build artefacts task -->
	<Target Name="Zipping" DependsOnTargets="UnitTesting">
		<ItemGroup>
			<FileToZip Include="**\*.exe" />
			<FileToZip Include="**\*.pdb" />
			<FileToZip Include="**\*.dll" />
		</ItemGroup>
		<!-- Report files' definition-->
		<ItemGroup>
			<ReportFile Include="$(MSBuildProjectDirectory)\OpenCoverage\**\*.*" />
		</ItemGroup>
		<!-- Zipping binaries -->
		<Zip
			Files="@(FileToZip)"
			ZipFileName="$(BinariesFile)"
			Flatten="true"
			ZipLevel="9"
			WorkingDirectory="$(MSBuildProjectDirectory)" 
		/>
		<!-- Zipping reports -->
		<Zip
			Files="@(ReportFile)"
			ZipFileName="$(ReportsFile)"
			ZipLevel="9"
			WorkingDirectory="$(MSBuildProjectDirectory)" 
		/>
	</Target>
	<ItemGroup>
		<Artifact Include="src/$(BinariesFile)" />
		<Artifact Include="src/$(ReportsFile)" />
		<Artifact Include="src/MSBuild.TeamCity.Tasks.$(Major).$(Minor).$(Build).$(Revision).msi" />
	</ItemGroup>
	<!-- Setting next build version and finish build process -->
	<Target Name="Build" DependsOnTargets="Zipping">
		<ItemGroup>
			<Project Include="MSBuildTeamCityTasks.shfbproj" />
			<Project Include="Setup\Setup.wixproj" />
		</ItemGroup>
		<!-- Updating WiX files -->
		<FileUpdate
			Files="$(MSBuildProjectDirectory)\Setup\Product.wxs"
			Regex='\$\(var\.SolutionDir\)'
			ReplacementText='$(MSBuildProjectDirectory)\' />
		<MSBuild
			StopOnFirstFailure="true"
			Projects="%(Project.Identity)"
			Properties="Configuration=$(Configuration)" 
		/>
		<Copy
			SourceFiles="@(SetupFile)"
			DestinationFiles="@(SetupDestinationFile)"
		/>
		<Delete Files="@(SetupFile)" />
		<Exec
			Command='python.exe $(MSBuildProjectDirectory)\googlecode_upload.py -p msbuildteamcitytasks -u $(GoogleLogin) -w $(GooglePassword) -s "Release $(Major).$(Minor) Build $(Build) $(Stage)" -l $(IsFeatured),Type-Installer,OpSys-Windows @(SetupDestinationFile)'
			Timeout="90000"
			Condition=" '$(IsUpload)'=='true' "
		/>
		<PublishArtifacts Artifacts="@(Artifact)"/>
		<Message Text="Build $(Major).$(Minor).$(Build).$(Revision) Complete"/>
	</Target>
</Project>